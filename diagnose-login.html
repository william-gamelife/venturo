<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨ºæ–·ç™»å…¥å•é¡Œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #0a0;
        }
        pre {
            background: #000;
            padding: 15px;
            border: 1px solid #0f0;
            overflow: auto;
            white-space: pre-wrap;
        }
        .error { color: #f00; }
        .warning { color: #ff0; }
        .success { color: #0f0; }
    </style>
</head>
<body>
    <h1>ğŸ” è¨ºæ–·ç™»å…¥å•é¡Œ</h1>
    
    <button onclick="checkUsers()">1. æª¢æŸ¥ä½¿ç”¨è€…è³‡æ–™</button>
    <button onclick="testLogin('william')">2. æ¸¬è©¦ William ç™»å…¥</button>
    <button onclick="testLogin('carson')">3. æ¸¬è©¦ Carson ç™»å…¥</button>
    <button onclick="testLogin('KAI')">4. æ¸¬è©¦ KAI ç™»å…¥</button>
    <button onclick="fixPasswords()">5. ä¿®å¾©å¯†ç¢¼ï¼ˆè¨­ç‚º pass1234ï¼‰</button>
    
    <pre id="output">è«‹é»æ“ŠæŒ‰éˆ•é–‹å§‹è¨ºæ–·...</pre>

    <script>
        // Supabase è¨­å®š
        const SUPABASE_URL = 'https://jjazipnkoccgmbpccalf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqYXppcG5rb2NjZ21icGNjYWxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MDMxOTIsImV4cCI6MjA3MTk3OTE5Mn0.jHH2Jf-gbx0UKqvUgxG-Nx2f_QwVqZBOFqtbAxzYvnY';
        const USERS_STORAGE_UUID = '550e8400-e29b-41d4-a716-446655440001';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const output = document.getElementById('output');
        
        // è¼‰å…¥ä½¿ç”¨è€…
        async function loadUsers() {
            try {
                const { data, error } = await supabase
                    .from('user_data')
                    .select('*')
                    .eq('user_id', USERS_STORAGE_UUID)
                    .eq('module', 'users')
                    .single();

                if (error) {
                    throw error;
                }

                if (data && Array.isArray(data.data)) {
                    return data.data;
                }

                return [];
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…å¤±æ•—:', error);
                throw error;
            }
        }
        
        // æª¢æŸ¥ä½¿ç”¨è€…è³‡æ–™
        async function checkUsers() {
            output.innerHTML = 'æª¢æŸ¥ä½¿ç”¨è€…è³‡æ–™...\n\n';
            
            try {
                const users = await loadUsers();
                output.innerHTML += `<span class="success">æ‰¾åˆ° ${users.length} å€‹ä½¿ç”¨è€…ï¼š</span>\n\n`;
                
                users.forEach((user, index) => {
                    output.innerHTML += `<span class="warning">${index + 1}. ${user.display_name || user.username}</span>\n`;
                    output.innerHTML += `   å¸³è™Ÿ: ${user.username}\n`;
                    output.innerHTML += `   UUID: ${user.uuid ? 
                        `<span class="success">${user.uuid}</span>` : 
                        '<span class="error">ç„¡ UUIDï¼éœ€è¦ç”Ÿæˆ</span>'}\n`;
                    output.innerHTML += `   å¯†ç¢¼: ${user.password ? 
                        `<span class="success">å·²è¨­å®š</span> (å€¼: "${user.password}")` : 
                        '<span class="error">ç„¡å¯†ç¢¼æ¬„ä½ï¼</span>'}\n`;
                    output.innerHTML += `   è§’è‰²: ${user.role}\n`;
                    output.innerHTML += `   è·ç¨±: ${user.title || 'æœªè¨­å®š'}\n\n`;
                });
                
                // è¨ºæ–·å•é¡Œ
                output.innerHTML += '\n<span class="warning">=== è¨ºæ–·çµæœ ===</span>\n';
                let hasProblems = false;
                
                users.forEach(user => {
                    const problems = [];
                    
                    if (!user.password) {
                        problems.push('æ²’æœ‰å¯†ç¢¼æ¬„ä½');
                    } else if (user.password !== 'pass1234') {
                        problems.push(`å¯†ç¢¼æ˜¯ "${user.password}" ä¸æ˜¯ "pass1234"`);
                    }
                    
                    if (!user.uuid) {
                        problems.push('æ²’æœ‰ UUID');
                    }
                    
                    if (problems.length > 0) {
                        hasProblems = true;
                        output.innerHTML += `\n<span class="error">${user.username}:</span>\n`;
                        problems.forEach(p => {
                            output.innerHTML += `  - ${p}\n`;
                        });
                    }
                });
                
                if (!hasProblems) {
                    output.innerHTML += '<span class="success">âœ… æ‰€æœ‰ä½¿ç”¨è€…è³‡æ–™éƒ½æ­£å¸¸</span>\n';
                } else {
                    output.innerHTML += '\n<span class="warning">ğŸ’¡ å»ºè­°ï¼šé»æ“Š "5. ä¿®å¾©å¯†ç¢¼" æŒ‰éˆ•ä¾†ä¿®æ­£å•é¡Œ</span>\n';
                }
                
            } catch (error) {
                output.innerHTML += `<span class="error">éŒ¯èª¤: ${error.message}</span>\n`;
            }
        }
        
        // æ¸¬è©¦ç™»å…¥
        async function testLogin(username) {
            output.innerHTML = `æ¸¬è©¦ç™»å…¥ ${username}...\n\n`;
            
            try {
                const users = await loadUsers();
                const user = users.find(u => 
                    u.username && u.username.toLowerCase() === username.toLowerCase()
                );
                
                if (!user) {
                    output.innerHTML += `<span class="error">âŒ æ‰¾ä¸åˆ°ä½¿ç”¨è€… ${username}</span>\n`;
                    return;
                }
                
                output.innerHTML += `æ‰¾åˆ°ä½¿ç”¨è€…:\n`;
                output.innerHTML += `- é¡¯ç¤ºåç¨±: ${user.display_name || user.username}\n`;
                output.innerHTML += `- å¸³è™Ÿ: ${user.username}\n`;
                output.innerHTML += `- å¯†ç¢¼æ¬„ä½: ${user.password ? `å­˜åœ¨ (å€¼: "${user.password}")` : 'ä¸å­˜åœ¨'}\n`;
                output.innerHTML += `- UUID: ${user.uuid || 'ç„¡'}\n\n`;
                
                output.innerHTML += `å˜—è©¦ç”¨å¯†ç¢¼ 'pass1234' ç™»å…¥...\n`;
                
                // æ¨¡æ“¬ç™»å…¥é©—è­‰
                if (!user.password) {
                    output.innerHTML += `<span class="error">âŒ ç™»å…¥å¤±æ•—ï¼šä½¿ç”¨è€…æ²’æœ‰å¯†ç¢¼æ¬„ä½</span>\n`;
                } else if (user.password !== 'pass1234') {
                    output.innerHTML += `<span class="error">âŒ ç™»å…¥å¤±æ•—ï¼šå¯†ç¢¼ä¸æ­£ç¢º</span>\n`;
                    output.innerHTML += `<span class="warning">   å¯¦éš›å¯†ç¢¼æ˜¯: "${user.password}"</span>\n`;
                } else {
                    output.innerHTML += `<span class="success">âœ… ç™»å…¥æˆåŠŸï¼</span>\n`;
                    if (user.uuid) {
                        output.innerHTML += `   UUID: ${user.uuid}\n`;
                    }
                }
                
            } catch (error) {
                output.innerHTML += `<span class="error">éŒ¯èª¤: ${error.message}</span>\n`;
            }
        }
        
        // ä¿®å¾©å¯†ç¢¼
        async function fixPasswords() {
            output.innerHTML = 'ä¿®å¾©æ‰€æœ‰ä½¿ç”¨è€…å¯†ç¢¼...\n\n';
            
            try {
                const users = await loadUsers();
                let modified = false;
                
                output.innerHTML += 'æª¢æŸ¥ä¸¦ä¿®å¾©æ¯å€‹ä½¿ç”¨è€…:\n';
                
                const fixedUsers = users.map(user => {
                    output.innerHTML += `\n${user.username}:\n`;
                    
                    // ä¿®å¾©å¯†ç¢¼
                    if (!user.password || user.password !== 'pass1234') {
                        output.innerHTML += `  <span class="warning">- è¨­å®šå¯†ç¢¼ç‚º pass1234</span>\n`;
                        user.password = 'pass1234';
                        modified = true;
                    } else {
                        output.innerHTML += `  <span class="success">- å¯†ç¢¼å·²ç¶“æ˜¯ pass1234</span>\n`;
                    }
                    
                    // ä¿®å¾© UUID
                    if (!user.uuid) {
                        const newUUID = crypto.randomUUID ? crypto.randomUUID() : 
                            'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                                const r = Math.random() * 16 | 0;
                                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                                return v.toString(16);
                            });
                        output.innerHTML += `  <span class="warning">- ç”Ÿæˆ UUID: ${newUUID}</span>\n`;
                        user.uuid = newUUID;
                        modified = true;
                    } else {
                        output.innerHTML += `  <span class="success">- UUID å·²å­˜åœ¨</span>\n`;
                    }
                    
                    // ç¢ºä¿æœ‰é¡¯ç¤ºåç¨±
                    if (!user.display_name) {
                        user.display_name = user.username;
                        modified = true;
                    }
                    
                    return user;
                });
                
                if (modified) {
                    output.innerHTML += '\n\nå„²å­˜ä¿®å¾©å¾Œçš„è³‡æ–™åˆ° Supabase...\n';
                    
                    const { data, error } = await supabase
                        .from('user_data')
                        .upsert({
                            user_id: USERS_STORAGE_UUID,
                            module: 'users',
                            data: fixedUsers,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,module'
                        });

                    if (error) {
                        output.innerHTML += `<span class="error">âŒ å„²å­˜å¤±æ•—: ${error.message}</span>\n`;
                    } else {
                        output.innerHTML += '<span class="success">âœ… ä¿®å¾©å®Œæˆï¼æ‰€æœ‰ä½¿ç”¨è€…å¯†ç¢¼éƒ½å·²è¨­ç‚º pass1234</span>\n';
                        output.innerHTML += '\nè«‹é‡æ–°æ•´ç† index.html ä¸¦å˜—è©¦ç™»å…¥\n';
                    }
                } else {
                    output.innerHTML += '\n<span class="success">âœ… æ‰€æœ‰ä½¿ç”¨è€…è³‡æ–™éƒ½æ­£å¸¸ï¼Œä¸éœ€è¦ä¿®å¾©</span>\n';
                }
                
            } catch (error) {
                output.innerHTML += `<span class="error">éŒ¯èª¤: ${error.message}</span>\n`;
            }
        }
        
        // æ¸¬è©¦é€£ç·š
        window.onload = async function() {
            output.innerHTML = 'æ¸¬è©¦ Supabase é€£ç·š...\n';
            try {
                const { data, error } = await supabase
                    .from('user_data')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    output.innerHTML += `<span class="error">é€£ç·šå¤±æ•—: ${error.message}</span>\n`;
                } else {
                    output.innerHTML += '<span class="success">âœ… Supabase é€£ç·šæ­£å¸¸</span>\n';
                    output.innerHTML += '\nè«‹é»æ“ŠæŒ‰éˆ•é–‹å§‹è¨ºæ–·...\n';
                }
            } catch (err) {
                output.innerHTML += `<span class="error">é€£ç·šéŒ¯èª¤: ${err.message}</span>\n`;
            }
        };
    </script>
</body>
</html>