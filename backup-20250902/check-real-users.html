<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æª¢æŸ¥å¯¦éš›ä½¿ç”¨è€…è³‡æ–™</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        pre {
            background: #000;
            padding: 15px;
            border: 1px solid #0f0;
            overflow: auto;
            white-space: pre-wrap;
        }
        .warning { color: #ff0; }
        .error { color: #f00; }
        .info { color: #0ff; }
    </style>
</head>
<body>
    <h1>ğŸ” æª¢æŸ¥ user_data è¡¨çš„å¯¦éš›ä½¿ç”¨è€…</h1>
    
    <button onclick="loadAllUserData()">è¼‰å…¥æ‰€æœ‰ user_data è¨˜éŒ„</button>
    <button onclick="findUsersModule()">åªæ‰¾ users æ¨¡çµ„</button>
    <button onclick="checkUsersStructure()">åˆ†æä½¿ç”¨è€…çµæ§‹</button>
    
    <pre id="output"></pre>

    <script>
        const SUPABASE_URL = 'https://jjazipnkoccgmbpccalf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqYXppcG5rb2NjZ21icGNjYWxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MDMxOTIsImV4cCI6MjA3MTk3OTE5Mn0.jHH2Jf-gbx0UKqvUgxG-Nx2f_QwVqZBOFqtbAxzYvnY';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const output = document.getElementById('output');

        // è¼‰å…¥æ‰€æœ‰ user_data è¨˜éŒ„
        async function loadAllUserData() {
            output.innerHTML = 'è¼‰å…¥æ‰€æœ‰ user_data è¨˜éŒ„...\n\n';
            
            try {
                // ä¸åŠ ä»»ä½•éæ¿¾ï¼Œè¼‰å…¥æ‰€æœ‰è¨˜éŒ„
                const { data, error } = await supabase
                    .from('user_data')
                    .select('*')
                    .order('updated_at', { ascending: false });
                
                if (error) {
                    output.innerHTML = `<span class="error">éŒ¯èª¤: ${JSON.stringify(error, null, 2)}</span>`;
                    return;
                }
                
                output.innerHTML = `<span class="info">æ‰¾åˆ° ${data.length} ç­†è¨˜éŒ„</span>\n\n`;
                
                // åˆ†ææ¯ç­†è¨˜éŒ„
                data.forEach((record, index) => {
                    output.innerHTML += `<span class="warning">è¨˜éŒ„ ${index + 1}:</span>\n`;
                    output.innerHTML += `  ID: ${record.id}\n`;
                    output.innerHTML += `  user_id: ${record.user_id}\n`;
                    output.innerHTML += `  module: <span class="info">${record.module}</span>\n`;
                    output.innerHTML += `  updated_at: ${record.updated_at}\n`;
                    
                    // å¦‚æœæ˜¯ users æ¨¡çµ„æˆ–åŒ…å«ä½¿ç”¨è€…è³‡æ–™
                    if (record.module === 'users' || 
                        (record.data && Array.isArray(record.data) && 
                         record.data.length > 0 && 
                         record.data[0].username)) {
                        output.innerHTML += `  <span class="warning">ğŸ“Œ å¯èƒ½æ˜¯ä½¿ç”¨è€…è³‡æ–™ï¼</span>\n`;
                        output.innerHTML += `  è³‡æ–™å…§å®¹:\n`;
                        if (Array.isArray(record.data)) {
                            record.data.forEach(user => {
                                output.innerHTML += `    - ${user.username || user.display_name}: ${user.role || '?'} (${user.title || '?'})\n`;
                            });
                        } else {
                            output.innerHTML += `    ${JSON.stringify(record.data).substring(0, 100)}...\n`;
                        }
                        
                        // å„²å­˜æ‰¾åˆ°çš„ä½¿ç”¨è€…è³‡æ–™
                        window.foundUsersRecord = record;
                    }
                    
                    output.innerHTML += '\n';
                });
                
            } catch (err) {
                output.innerHTML = `<span class="error">éŒ¯èª¤: ${err.message}</span>`;
            }
        }

        // åªæ‰¾ users æ¨¡çµ„
        async function findUsersModule() {
            output.innerHTML = 'æœå°‹ users æ¨¡çµ„...\n\n';
            
            try {
                // ç›´æ¥æœå°‹ module = 'users'
                const { data, error } = await supabase
                    .from('user_data')
                    .select('*')
                    .eq('module', 'users');
                
                if (error) {
                    output.innerHTML = `<span class="error">éŒ¯èª¤: ${JSON.stringify(error, null, 2)}</span>`;
                    return;
                }
                
                if (data.length === 0) {
                    output.innerHTML = '<span class="warning">æ²’æœ‰æ‰¾åˆ° module = "users" çš„è¨˜éŒ„</span>\n\n';
                    output.innerHTML += 'å¯èƒ½åŸå› ï¼š\n';
                    output.innerHTML += '1. ä½¿ç”¨è€…è³‡æ–™å­˜åœ¨å…¶ä»–æ¨¡çµ„åç¨±ä¸‹\n';
                    output.innerHTML += '2. ä½¿ç”¨è€…è³‡æ–™ä½¿ç”¨ä¸åŒçš„ user_id\n';
                    output.innerHTML += '3. å¾æœªæ­£ç¢ºå„²å­˜éä½¿ç”¨è€…è³‡æ–™\n';
                } else {
                    output.innerHTML = `<span class="info">æ‰¾åˆ° ${data.length} ç­† users æ¨¡çµ„è¨˜éŒ„</span>\n\n`;
                    
                    data.forEach((record, index) => {
                        output.innerHTML += `<span class="warning">ä½¿ç”¨è€…è³‡æ–™ ${index + 1}:</span>\n`;
                        output.innerHTML += `user_id: ${record.user_id}\n`;
                        output.innerHTML += `æ›´æ–°æ™‚é–“: ${record.updated_at}\n`;
                        output.innerHTML += `ä½¿ç”¨è€…åˆ—è¡¨:\n`;
                        
                        if (Array.isArray(record.data)) {
                            record.data.forEach(user => {
                                output.innerHTML += `\n<span class="info">ğŸ‘¤ ${user.display_name || user.username}</span>\n`;
                                output.innerHTML += `   å¸³è™Ÿ: ${user.username}\n`;
                                output.innerHTML += `   UUID: ${user.uuid || '<span class="error">ç„¡UUID</span>'}\n`;
                                output.innerHTML += `   è§’è‰²: ${user.role}\n`;
                                output.innerHTML += `   è·ç¨±: ${user.title}\n`;
                                output.innerHTML += `   å¯†ç¢¼: ${user.password ? 'å·²è¨­å®š' : '<span class="error">ç„¡å¯†ç¢¼</span>'}\n`;
                            });
                            
                            // å„²å­˜è³‡æ–™
                            window.actualUsers = record.data;
                            window.usersRecord = record;
                        } else {
                            output.innerHTML += JSON.stringify(record.data, null, 2);
                        }
                        output.innerHTML += '\n---\n';
                    });
                }
                
            } catch (err) {
                output.innerHTML = `<span class="error">éŒ¯èª¤: ${err.message}</span>`;
            }
        }

        // åˆ†æä½¿ç”¨è€…çµæ§‹
        async function checkUsersStructure() {
            output.innerHTML = 'åˆ†æä½¿ç”¨è€…è³‡æ–™çµæ§‹...\n\n';
            
            if (!window.actualUsers && !window.foundUsersRecord) {
                output.innerHTML += '<span class="warning">è«‹å…ˆåŸ·è¡Œã€Œè¼‰å…¥æ‰€æœ‰ user_data è¨˜éŒ„ã€æˆ–ã€Œåªæ‰¾ users æ¨¡çµ„ã€</span>\n';
                return;
            }
            
            const users = window.actualUsers || window.foundUsersRecord?.data;
            
            if (!Array.isArray(users)) {
                output.innerHTML += '<span class="error">æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ä½¿ç”¨è€…é™£åˆ—è³‡æ–™</span>\n';
                return;
            }
            
            output.innerHTML += `<span class="info">=== ç™¼ç¾ ${users.length} å€‹ä½¿ç”¨è€… ===</span>\n\n`;
            
            // åˆ†ææ¯å€‹ä½¿ç”¨è€…
            const problems = [];
            const validUsers = [];
            
            users.forEach((user, index) => {
                output.innerHTML += `${index + 1}. <span class="warning">${user.display_name || user.username || 'æœªçŸ¥'}</span>\n`;
                
                const userProblems = [];
                
                // æª¢æŸ¥å¿…è¦æ¬„ä½
                if (!user.username) userProblems.push('ç¼ºå°‘ username');
                if (!user.uuid) userProblems.push('ç¼ºå°‘ UUID');
                if (!user.password) userProblems.push('ç¼ºå°‘å¯†ç¢¼');
                if (!user.display_name) userProblems.push('ç¼ºå°‘é¡¯ç¤ºåç¨±');
                
                if (userProblems.length > 0) {
                    output.innerHTML += `   <span class="error">å•é¡Œ: ${userProblems.join(', ')}</span>\n`;
                    problems.push({ user, problems: userProblems });
                } else {
                    output.innerHTML += `   <span class="info">âœ… è³‡æ–™å®Œæ•´</span>\n`;
                    validUsers.push(user);
                }
                
                // é¡¯ç¤ºç¾æœ‰è³‡æ–™
                output.innerHTML += `   ç¾æœ‰è³‡æ–™:\n`;
                Object.keys(user).forEach(key => {
                    const value = key === 'password' ? '***' : user[key];
                    output.innerHTML += `     ${key}: ${value}\n`;
                });
                output.innerHTML += '\n';
            });
            
            // ç¸½çµ
            output.innerHTML += '\n<span class="warning">=== ç¸½çµ ===</span>\n';
            output.innerHTML += `âœ… å®Œæ•´çš„ä½¿ç”¨è€…: ${validUsers.length}\n`;
            output.innerHTML += `âŒ æœ‰å•é¡Œçš„ä½¿ç”¨è€…: ${problems.length}\n`;
            
            if (problems.length > 0) {
                output.innerHTML += '\n<span class="error">éœ€è¦ä¿®å¾©çš„å•é¡Œ:</span>\n';
                problems.forEach(({ user, problems }) => {
                    output.innerHTML += `- ${user.username || user.display_name || 'æœªçŸ¥'}: ${problems.join(', ')}\n`;
                });
                
                output.innerHTML += '\n<span class="info">å»ºè­°ä¿®å¾©æ–¹æ¡ˆ:</span>\n';
                output.innerHTML += '1. ç‚ºç¼ºå°‘ UUID çš„ä½¿ç”¨è€…ç”Ÿæˆæ–°çš„ UUID\n';
                output.innerHTML += '2. è¨­å®šé è¨­å¯†ç¢¼ (å¦‚ pass1234)\n';
                output.innerHTML += '3. è£œå……ç¼ºå°‘çš„æ¬„ä½\n';
                output.innerHTML += '4. æ›´æ–° auth.js ä¾†è®€å–é€™äº›è³‡æ–™\n';
            }
            
            window.analyzedUsers = { valid: validUsers, problems };
        }
    </script>
</body>
</html>