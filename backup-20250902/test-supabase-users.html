<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦ Supabase Users è¡¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #0f0;
            border-radius: 5px;
        }
        .error { color: #f00; }
        .success { color: #0f0; }
        .info { color: #ff0; }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #0a0;
        }
        pre {
            background: #000;
            padding: 10px;
            overflow: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Supabase Users è¡¨æ¸¬è©¦å·¥å…·</h1>
    
    <div class="section">
        <h2>1. é€£ç·šç‹€æ…‹</h2>
        <div id="connectionStatus">æª¢æŸ¥ä¸­...</div>
    </div>

    <div class="section">
        <h2>2. Users è¡¨çµæ§‹</h2>
        <button onclick="checkUsersTable()">æª¢æŸ¥ users è¡¨</button>
        <button onclick="checkUserData()">æª¢æŸ¥ user_data è¡¨</button>
        <pre id="tableStructure"></pre>
    </div>

    <div class="section">
        <h2>3. ç¾æœ‰ä½¿ç”¨è€…è³‡æ–™</h2>
        <button onclick="loadUsers()">è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…</button>
        <pre id="usersData"></pre>
    </div>

    <div class="section">
        <h2>4. å»ºç«‹æ¸¬è©¦ä½¿ç”¨è€…</h2>
        <button onclick="createTestUsers()">å»ºç«‹é è¨­ä½¿ç”¨è€…ï¼ˆWilliam, Carson, Jessï¼‰</button>
        <pre id="createResult"></pre>
    </div>

    <div class="section">
        <h2>5. UUID æ¸¬è©¦</h2>
        <button onclick="testUUID()">æ¸¬è©¦ UUID ç”Ÿæˆèˆ‡å„²å­˜</button>
        <pre id="uuidTest"></pre>
    </div>

    <script>
        // Supabase è¨­å®š
        const SUPABASE_URL = 'https://jjazipnkoccgmbpccalf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqYXppcG5rb2NjZ21icGNjYWxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MDMxOTIsImV4cCI6MjA3MTk3OTE5Mn0.jHH2Jf-gbx0UKqvUgxG-Nx2f_QwVqZBOFqtbAxzYvnY';
        
        let supabase = null;

        // åˆå§‹åŒ–
        function init() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                document.getElementById('connectionStatus').innerHTML = 
                    '<span class="success">âœ… Supabase é€£ç·šæˆåŠŸ</span>';
            } catch (error) {
                document.getElementById('connectionStatus').innerHTML = 
                    `<span class="error">âŒ é€£ç·šå¤±æ•—: ${error.message}</span>`;
            }
        }

        // æª¢æŸ¥ users è¡¨
        async function checkUsersTable() {
            const output = document.getElementById('tableStructure');
            output.innerHTML = 'æª¢æŸ¥ä¸­...';
            
            try {
                // å˜—è©¦æŸ¥è©¢ users è¡¨
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    if (error.code === '42P01') {
                        output.innerHTML = `<span class="info">âš ï¸ users è¡¨ä¸å­˜åœ¨ï¼Œéœ€è¦å»ºç«‹</span>\n\nå»ºè­°çš„è¡¨çµæ§‹ï¼š
CREATE TABLE users (
  uuid UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username TEXT UNIQUE NOT NULL,
  display_name TEXT NOT NULL,
  password TEXT NOT NULL,
  role TEXT DEFAULT 'user',
  title TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);`;
                    } else {
                        output.innerHTML = `<span class="error">éŒ¯èª¤: ${JSON.stringify(error, null, 2)}</span>`;
                    }
                } else {
                    output.innerHTML = `<span class="success">âœ… users è¡¨å­˜åœ¨</span>\n\nç¯„ä¾‹è³‡æ–™ï¼š\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (err) {
                output.innerHTML = `<span class="error">éŒ¯èª¤: ${err.message}</span>`;
            }
        }

        // æª¢æŸ¥ user_data è¡¨
        async function checkUserData() {
            const output = document.getElementById('tableStructure');
            output.innerHTML = 'æª¢æŸ¥ä¸­...';
            
            try {
                const { data, error } = await supabase
                    .from('user_data')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    output.innerHTML = `<span class="error">éŒ¯èª¤: ${JSON.stringify(error, null, 2)}</span>`;
                } else {
                    output.innerHTML = `<span class="success">âœ… user_data è¡¨å­˜åœ¨</span>\n\nç¯„ä¾‹è³‡æ–™ï¼š\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (err) {
                output.innerHTML = `<span class="error">éŒ¯èª¤: ${err.message}</span>`;
            }
        }

        // è¼‰å…¥ä½¿ç”¨è€…
        async function loadUsers() {
            const output = document.getElementById('usersData');
            output.innerHTML = 'è¼‰å…¥ä¸­...';
            
            try {
                // å…ˆå˜—è©¦å¾ users è¡¨è¼‰å…¥
                let { data, error } = await supabase
                    .from('users')
                    .select('*');
                
                if (error) {
                    // å¦‚æœ users è¡¨ä¸å­˜åœ¨ï¼Œå˜—è©¦å¾ user_data è¼‰å…¥
                    const { data: userData, error: userDataError } = await supabase
                        .from('user_data')
                        .select('*')
                        .eq('module', 'users');
                    
                    if (userDataError) {
                        output.innerHTML = `<span class="error">å…©å€‹è¡¨éƒ½ç„¡æ³•è®€å–ï¼š\n${JSON.stringify(userDataError, null, 2)}</span>`;
                    } else {
                        output.innerHTML = `<span class="info">å¾ user_data è¡¨è¼‰å…¥ï¼š</span>\n${JSON.stringify(userData, null, 2)}`;
                    }
                } else {
                    output.innerHTML = `<span class="success">å¾ users è¡¨è¼‰å…¥ï¼š</span>\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (err) {
                output.innerHTML = `<span class="error">éŒ¯èª¤: ${err.message}</span>`;
            }
        }

        // å»ºç«‹æ¸¬è©¦ä½¿ç”¨è€…
        async function createTestUsers() {
            const output = document.getElementById('createResult');
            output.innerHTML = 'å»ºç«‹ä¸­...';
            
            const testUsers = [
                {
                    username: 'william',
                    display_name: 'William',
                    password: 'pass1234',
                    role: 'admin',
                    title: 'ITä¸»ç®¡'
                },
                {
                    username: 'carson',
                    display_name: 'Carson',
                    password: 'pass1234',
                    role: 'admin',
                    title: 'å·¥ç¨‹å¸«'
                },
                {
                    username: 'jess',
                    display_name: 'Jess',
                    password: 'pass1234',
                    role: 'user',
                    title: 'å°ˆæ¡ˆç¶“ç†'
                }
            ];
            
            try {
                // å˜—è©¦æ’å…¥åˆ° users è¡¨
                const { data, error } = await supabase
                    .from('users')
                    .upsert(testUsers, { onConflict: 'username' })
                    .select();
                
                if (error) {
                    output.innerHTML = `<span class="error">å»ºç«‹å¤±æ•—ï¼š\n${JSON.stringify(error, null, 2)}</span>`;
                } else {
                    output.innerHTML = `<span class="success">âœ… å»ºç«‹æˆåŠŸï¼š</span>\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (err) {
                output.innerHTML = `<span class="error">éŒ¯èª¤: ${err.message}</span>`;
            }
        }

        // æ¸¬è©¦ UUID
        async function testUUID() {
            const output = document.getElementById('uuidTest');
            output.innerHTML = 'æ¸¬è©¦ä¸­...';
            
            try {
                // ç”Ÿæˆæ¸¬è©¦ UUID
                const testUUID = crypto.randomUUID();
                output.innerHTML = `ç”Ÿæˆçš„ UUID: ${testUUID}\n\n`;
                
                // æª¢æŸ¥æ¯å€‹ä½¿ç”¨è€…æ˜¯å¦æœ‰ UUID
                const { data, error } = await supabase
                    .from('users')
                    .select('username, uuid');
                
                if (error) {
                    output.innerHTML += `<span class="error">ç„¡æ³•æª¢æŸ¥ UUIDï¼š${error.message}</span>`;
                } else {
                    output.innerHTML += 'ä½¿ç”¨è€… UUID ç‹€æ…‹ï¼š\n';
                    data.forEach(user => {
                        const status = user.uuid ? 'âœ… æœ‰ UUID' : 'âŒ ç¼ºå°‘ UUID';
                        output.innerHTML += `${user.username}: ${status} ${user.uuid || ''}\n`;
                    });
                }
            } catch (err) {
                output.innerHTML = `<span class="error">éŒ¯èª¤: ${err.message}</span>`;
            }
        }

        // åˆå§‹åŒ–
        window.onload = init;
    </script>
</body>
</html>