<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameLife ä½¿ç”¨è€…é«”é©—æ¸¬è©¦</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f4f1eb 0%, #e8e2d5 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .user-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .user-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }
        
        .user-card.selected {
            border-color: #c9a961;
            background: linear-gradient(135deg, #fff 0%, #fefcf8 100%);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #c9a961, #7a8b74);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 600;
        }
        
        .user-details h3 {
            color: #3a3833;
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .user-role {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            color: white;
        }
        
        .role-super { background: #e74c3c; }
        .role-business { background: #3498db; }
        .role-general { background: #2ecc71; }
        
        .user-permissions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .permission-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }
        
        .permission-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .permission-tag {
            padding: 4px 8px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 11px;
            color: #666;
        }
        
        .permission-tag.allowed {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .permission-tag.denied {
            background: #ffebee;
            color: #c62828;
        }
        
        .test-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #3a3833;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .login-form {
            display: none;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #c9a961;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #c9a961;
            color: white;
        }
        
        .btn-primary:hover {
            background: #b5976e;
        }
        
        .test-results {
            margin-top: 20px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f8f9fa;
        }
        
        .result-success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .result-error {
            background: #ffebee;
            color: #c62828;
        }
        
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .module-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            font-size: 12px;
            border: 2px solid transparent;
        }
        
        .module-item.accessible {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #c8e6c9;
        }
        
        .module-item.restricted {
            background: #ffebee;
            color: #c62828;
            border-color: #ffcdd2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="test-header">
            <h1>ğŸ® GameLife ä½¿ç”¨è€…é«”é©—æ¸¬è©¦</h1>
            <p>æ¨¡æ“¬ä¸åŒæ¬Šé™ä½¿ç”¨è€…çš„å®Œæ•´æ“ä½œæµç¨‹</p>
        </div>

        <!-- ä½¿ç”¨è€…é¸æ“‡å¡ç‰‡ -->
        <div class="user-cards">
            <div class="user-card" onclick="selectUser('william')" id="card-william">
                <div class="user-info">
                    <div class="user-avatar">å¨</div>
                    <div class="user-details">
                        <h3>å¨å»‰ (William)</h3>
                        <span class="user-role role-super">è¶…ç´šç®¡ç†å“¡</span>
                    </div>
                </div>
                <div class="user-permissions">
                    <div class="permission-title">æ¬Šé™ç¯„åœ:</div>
                    <div class="permission-list">
                        <span class="permission-tag allowed">äººå“¡ç®¡ç†</span>
                        <span class="permission-tag allowed">æ‰€æœ‰æ¨¡çµ„</span>
                        <span class="permission-tag allowed">ç³»çµ±è¨­å®š</span>
                        <span class="permission-tag allowed">å°ˆæ¡ˆæ‰“åŒ…</span>
                    </div>
                </div>
                <div class="login-form" id="form-william">
                    <div class="form-group">
                        <label>å¸³è™Ÿ:</label>
                        <input type="text" value="william" readonly>
                    </div>
                    <div class="form-group">
                        <label>å¯†ç¢¼:</label>
                        <input type="password" id="password-william" placeholder="è¼¸å…¥å¯†ç¢¼">
                    </div>
                    <button class="btn btn-primary" onclick="testLogin('william')">ç™»å…¥æ¸¬è©¦</button>
                </div>
            </div>

            <div class="user-card" onclick="selectUser('carson')" id="card-carson">
                <div class="user-info">
                    <div class="user-avatar">C</div>
                    <div class="user-details">
                        <h3>Carson</h3>
                        <span class="user-role role-business">å•†å‹™ç®¡ç†å“¡</span>
                    </div>
                </div>
                <div class="user-permissions">
                    <div class="permission-title">æ¬Šé™ç¯„åœ:</div>
                    <div class="permission-list">
                        <span class="permission-tag denied">äººå“¡ç®¡ç†</span>
                        <span class="permission-tag allowed">æ¥­å‹™æ¨¡çµ„</span>
                        <span class="permission-tag allowed">éƒ¨åˆ†è¨­å®š</span>
                        <span class="permission-tag allowed">å°ˆæ¡ˆæ‰“åŒ…</span>
                    </div>
                </div>
                <div class="login-form" id="form-carson">
                    <div class="form-group">
                        <label>å¸³è™Ÿ:</label>
                        <input type="text" value="carson" readonly>
                    </div>
                    <div class="form-group">
                        <label>å¯†ç¢¼:</label>
                        <input type="password" id="password-carson" placeholder="è¼¸å…¥å¯†ç¢¼">
                    </div>
                    <button class="btn btn-primary" onclick="testLogin('carson')">ç™»å…¥æ¸¬è©¦</button>
                </div>
            </div>

            <div class="user-card" onclick="selectUser('kai')" id="card-kai">
                <div class="user-info">
                    <div class="user-avatar">K</div>
                    <div class="user-details">
                        <h3>KAI</h3>
                        <span class="user-role role-general">ä¸€èˆ¬ä½¿ç”¨è€…</span>
                    </div>
                </div>
                <div class="user-permissions">
                    <div class="permission-title">æ¬Šé™ç¯„åœ:</div>
                    <div class="permission-list">
                        <span class="permission-tag denied">äººå“¡ç®¡ç†</span>
                        <span class="permission-tag denied">å°ˆæ¡ˆç®¡ç†</span>
                        <span class="permission-tag allowed">åŸºæœ¬åŠŸèƒ½</span>
                        <span class="permission-tag denied">å°ˆæ¡ˆæ‰“åŒ…</span>
                    </div>
                </div>
                <div class="login-form" id="form-kai">
                    <div class="form-group">
                        <label>å¸³è™Ÿ:</label>
                        <input type="text" value="kai" readonly>
                    </div>
                    <div class="form-group">
                        <label>å¯†ç¢¼:</label>
                        <input type="password" id="password-kai" placeholder="è¼¸å…¥å¯†ç¢¼">
                    </div>
                    <button class="btn btn-primary" onclick="testLogin('kai')">ç™»å…¥æ¸¬è©¦</button>
                </div>
            </div>
        </div>

        <!-- æ¸¬è©¦çµæœå€åŸŸ -->
        <div class="test-section" id="login-results" style="display: none;">
            <div class="section-title">
                ğŸ” ç™»å…¥æ¸¬è©¦çµæœ
            </div>
            <div class="test-results" id="login-status"></div>
        </div>

        <div class="test-section" id="module-access" style="display: none;">
            <div class="section-title">
                ğŸ“± æ¨¡çµ„å­˜å–æ¸¬è©¦
            </div>
            <div class="module-grid" id="module-list"></div>
        </div>

        <div class="test-section" id="permission-tests" style="display: none;">
            <div class="section-title">
                âš™ï¸ åŠŸèƒ½æ¬Šé™æ¸¬è©¦
            </div>
            <div class="test-results" id="permission-results"></div>
        </div>
    </div>

    <!-- è¼‰å…¥æ¬Šé™ç³»çµ± -->
    <script src="./permission-helper.js"></script>
    <script src="./auth-bridge.js"></script>

    <script>
        let selectedUser = null;
        let currentUser = null;

        // é è¨­å¯†ç¢¼
        const defaultPasswords = {
            william: 'pass1234',
            carson: 'pass1234',
            kai: 'pass1234'
        };

        function selectUser(username) {
            // æ¸…é™¤ä¹‹å‰çš„é¸æ“‡
            document.querySelectorAll('.user-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.login-form').style.display = 'none';
            });

            // é¸æ“‡æ–°ä½¿ç”¨è€…
            const card = document.getElementById(`card-${username}`);
            const form = document.getElementById(`form-${username}`);
            
            card.classList.add('selected');
            form.style.display = 'block';

            // è‡ªå‹•å¡«å…¥é è¨­å¯†ç¢¼ä»¥ä¾¿æ¸¬è©¦
            const passwordInput = document.getElementById(`password-${username}`);
            passwordInput.value = defaultPasswords[username];

            selectedUser = username;

            // éš±è—æ¸¬è©¦çµæœ
            hideTestResults();
        }

        async function testLogin(username) {
            const password = document.getElementById(`password-${username}`).value;
            
            if (!password) {
                alert('è«‹è¼¸å…¥å¯†ç¢¼');
                return;
            }

            try {
                console.log('æ¸¬è©¦ç™»å…¥:', username, password);
                
                // ä½¿ç”¨æ¬Šé™ç³»çµ±é©—è­‰
                const permissionHelper = getPermissionHelper();
                const user = permissionHelper.validateUser(username, password);

                if (user) {
                    currentUser = user;
                    showLoginSuccess(user);
                    testModuleAccess(user);
                    testPermissions(user);
                } else {
                    showLoginError('ç™»å…¥å¤±æ•—ï¼šå¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
                }
            } catch (error) {
                console.error('ç™»å…¥æ¸¬è©¦éŒ¯èª¤:', error);
                showLoginError('ç³»çµ±éŒ¯èª¤ï¼š' + error.message);
            }
        }

        function showLoginSuccess(user) {
            const resultsDiv = document.getElementById('login-results');
            const statusDiv = document.getElementById('login-status');
            
            statusDiv.innerHTML = `
                <div class="result-item result-success">
                    <span>âœ… ç™»å…¥æˆåŠŸ</span>
                    <span>${user.displayName} (${user.role})</span>
                </div>
                <div class="result-item">
                    <span>UUID:</span>
                    <span>${user.uuid}</span>
                </div>
                <div class="result-item">
                    <span>æ¬Šé™ç­‰ç´š:</span>
                    <span>${getRoleLevel(user.role)}</span>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        function showLoginError(message) {
            const resultsDiv = document.getElementById('login-results');
            const statusDiv = document.getElementById('login-status');
            
            statusDiv.innerHTML = `
                <div class="result-item result-error">
                    <span>âŒ ${message}</span>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        function testModuleAccess(user) {
            const permissionHelper = getPermissionHelper();
            const allModules = [
                'users', 'overview', 'todos', 'calendar', 'finance',
                'projects', 'timebox', 'life-simulator', 'pixel-life',
                'travel-pdf', 'settings', 'themes', 'sync', 'permissions'
            ];

            const moduleListDiv = document.getElementById('module-list');
            const accessDiv = document.getElementById('module-access');
            
            let moduleHTML = '';
            
            allModules.forEach(module => {
                const canAccess = permissionHelper.canAccessModule(user.uuid, module);
                const canModify = permissionHelper.canModifyModule(user.uuid, module);
                const canDelete = permissionHelper.canDeleteFromModule(user.uuid, module);
                
                const accessClass = canAccess ? 'accessible' : 'restricted';
                const accessText = canAccess ? 'âœ…' : 'âŒ';
                const permissionText = canAccess ? 
                    `è®€${canAccess ? 'âœ“' : 'âœ—'} å¯«${canModify ? 'âœ“' : 'âœ—'} åˆª${canDelete ? 'âœ“' : 'âœ—'}` : 
                    'ç„¡æ¬Šé™';
                
                moduleHTML += `
                    <div class="module-item ${accessClass}">
                        <div style="font-weight: 600;">${module}</div>
                        <div>${accessText}</div>
                        <div style="font-size: 10px; margin-top: 4px;">${permissionText}</div>
                    </div>
                `;
            });
            
            moduleListDiv.innerHTML = moduleHTML;
            accessDiv.style.display = 'block';
        }

        function testPermissions(user) {
            const permissionHelper = getPermissionHelper();
            const resultsDiv = document.getElementById('permission-results');
            const sectionDiv = document.getElementById('permission-tests');
            
            // æ¸¬è©¦ç‰¹æ®ŠåŠŸèƒ½
            const canPackage = permissionHelper.canUsePackageFeature(user.uuid);
            const isSuperAdmin = permissionHelper.isSuperAdmin(user.uuid);
            const isBusinessAdmin = permissionHelper.isBusinessAdmin(user.uuid);
            const visibleModules = permissionHelper.getVisibleModules(user.uuid);
            
            resultsDiv.innerHTML = `
                <div class="result-item ${canPackage ? 'result-success' : 'result-error'}">
                    <span>å°ˆæ¡ˆæ‰“åŒ…åŠŸèƒ½</span>
                    <span>${canPackage ? 'âœ… å¯ä½¿ç”¨' : 'âŒ ç„¡æ¬Šé™'}</span>
                </div>
                <div class="result-item ${isSuperAdmin ? 'result-success' : ''}">
                    <span>è¶…ç´šç®¡ç†å“¡</span>
                    <span>${isSuperAdmin ? 'âœ… æ˜¯' : 'âŒ å¦'}</span>
                </div>
                <div class="result-item ${isBusinessAdmin ? 'result-success' : ''}">
                    <span>å•†å‹™ç®¡ç†å“¡</span>
                    <span>${isBusinessAdmin ? 'âœ… æ˜¯' : 'âŒ å¦'}</span>
                </div>
                <div class="result-item">
                    <span>å¯è¦‹æ¨¡çµ„æ•¸é‡</span>
                    <span>${visibleModules.length} å€‹</span>
                </div>
            `;
            
            sectionDiv.style.display = 'block';
        }

        function getRoleLevel(role) {
            const levels = {
                'SUPER_ADMIN': '100 (æœ€é«˜æ¬Šé™)',
                'BUSINESS_ADMIN': '50 (å•†å‹™æ¬Šé™)',
                'GENERAL_USER': '10 (åŸºæœ¬æ¬Šé™)'
            };
            return levels[role] || 'æœªçŸ¥';
        }

        function hideTestResults() {
            document.getElementById('login-results').style.display = 'none';
            document.getElementById('module-access').style.display = 'none';
            document.getElementById('permission-tests').style.display = 'none';
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ® ä½¿ç”¨è€…é«”é©—æ¸¬è©¦é é¢å·²è¼‰å…¥');
            console.log('ğŸ’¡ é»æ“Šä½¿ç”¨è€…å¡ç‰‡é–‹å§‹æ¸¬è©¦ç™»å…¥æµç¨‹');
        });
    </script>
</body>
</html>